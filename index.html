<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>反応時間測定アプリ</title>
    <style>
        body, html { height: 100%; margin: 0; overflow: hidden; font-family: sans-serif; background-color: #f0f0f0; }
        .container { display: flex; justify-content: center; align-items: center; height: 100%; padding: 20px; box-sizing: border-box; }
        /* 共通のボタンスタイル */
        button { font-size: 18px; padding: 12px 24px; cursor: pointer; border: none; border-radius: 5px; background-color: #007bff; color: white; margin-top: 10px; }
        /* 入力フォームのスタイル */
        #setup-form { text-align: center; max-width: 400px; width: 100%; }
        #setup-form h2 { margin-top: 0; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { font-size: 16px; padding: 10px; width: 100%; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        /* 測定エリアのスタイル */
        #touch-area { display: none; width: 100%; height: 100%; justify-content: center; align-items: center; background-color: #3498db; color: white; font-size: 24px; text-align: center; transition: background-color 0.1s; }
        #touch-area.waiting { background-color: #f1c40f; }
        #touch-area.go { background-color: #2ecc71; }
        p { white-space: pre-wrap; }
    </style>
</head>
<body>

<div id="setup-container" class="container">
    <div id="setup-form">
        <h2>パフォーマンス測定</h2>
        <div class="form-group"><label for="name-input">名前</label><input type="text" id="name-input" placeholder="名前を入力"></div>
        <div class="form-group"><label for="age-input">年齢</label><input type="number" id="age-input" placeholder="年齢を入力"></div>
        <div class="form-group"><label for="sleepiness-select">眠気 (1-5)</label><select id="sleepiness-select"><option value="1">1: 全く眠くない</option><option value="2">2: 少し眠い</option><option value="3" selected>3: 普通</option><option value="4">4: かなり眠い</option><option value="5">5: 非常に眠い</option></select></div>
        <div class="form-group"><label for="fatigue-select">疲労度 (1-5)</label><select id="fatigue-select"><option value="1">1: 全く疲れていない</option><option value="2">2: 少し疲れている</option><option value="3" selected>3: 普通</option><option value="4">4: かなり疲れている</option><option value="5">5: 極度に疲れている</option></select></div>
        <div class="form-group"><label for="alcohol-select">アルコール (直近3時間以内)</label><select id="alcohol-select"><option value="なし">なし</option><option value="あり">あり</option></select></div>
        <div class="form-group"><label for="caffeine-select">カフェイン (直近3時間以内)</label><select id="caffeine-select"><option value="なし">なし</option><option value="あり">あり</option></select></div>
        <button id="start-btn">測定開始 (10回)</button>
    </div>
</div>

<div id="touch-area"><p id="message"></p></div>

<script>
    // GASのウェブアプリURL (必ずご自身のものに書き換えてください)
    const webAppUrl = 'ここにステップ2で再デプロイした最新のURLを貼り付け';

    // 定数とセッション変数
    const TOTAL_TRIALS = 10;
    let trialCount = 0;
    let resultsArray = [];
    let sessionData = {}; // セッション情報をまとめるオブジェクト
    let timerId;
    let startTime;
    let appState = 'initial';

    // HTML要素
    const setupContainer = document.getElementById('setup-container');
    const touchArea = document.getElementById('touch-area');
    const message = document.getElementById('message');
    const startBtn = document.getElementById('start-btn');
    
    // 「測定開始」ボタン
    startBtn.addEventListener('click', () => {
        // 入力値を取得してsessionDataオブジェクトに保存
        sessionData = {
            name: document.getElementById('name-input').value || '未入力',
            age: document.getElementById('age-input').value || '未入力',
            sleepiness: document.getElementById('sleepiness-select').value,
            fatigue: document.getElementById('fatigue-select').value,
            alcohol: document.getElementById('alcohol-select').value,
            caffeine: document.getElementById('caffeine-select').value
        };
        
        trialCount = 0;
        resultsArray = [];
        
        setupContainer.style.display = 'none';
        touchArea.style.display = 'flex';
        prepareNextTrial();
    });

    // 次の試行を準備
    function prepareNextTrial() {
        if (trialCount >= TOTAL_TRIALS) {
            showFinalResults();
            return;
        }
        trialCount++;
        appState = 'initial';
        touchArea.style.backgroundColor = '#3498db';
        touchArea.classList.remove('waiting', 'go');
        message.textContent = `試行 ${trialCount} / ${TOTAL_TRIALS}\n\n画面に触れ続けてください`;
    }

    // 最終結果表示
    function showFinalResults() {
        const sum = resultsArray.reduce((a, b) => a + b, 0);
        const avg = (sum / resultsArray.length).toFixed(2);
        message.innerHTML = `全10回の測定が完了しました。\n\n平均反応時間: ${avg} ms<br><br><button onclick="restartSession()">最初の画面に戻る</button>`;
        touchArea.style.backgroundColor = '#3498db';
    }
    
    // セッションをリスタート
    function restartSession() {
        touchArea.style.display = 'none';
        setupContainer.style.display = 'flex';
    }

    // touchstart イベント
    touchArea.addEventListener('touchstart', e => {
        e.preventDefault();
        if (appState === 'initial') {
            appState = 'waiting';
            touchArea.classList.add('waiting');
            message.textContent = '準備... 合図が出たら指を離して！';
            const randomDelay = Math.random() * 3000 + 2000;
            timerId = setTimeout(startMeasurement, randomDelay);
        }
    });

    // touchend イベント
    touchArea.addEventListener('touchend', e => {
        e.preventDefault();
        if (appState === 'go') {
            const endTime = performance.now();
            const reactionTime = parseFloat((endTime - startTime).toFixed(2));
            
            appState = 'result';
            message.textContent = `結果: ${reactionTime} ms\n\n記録しました。`;
            resultsArray.push(reactionTime);
            saveDataToSheet(trialCount, reactionTime);
            
            touchArea.classList.remove('go');
            setTimeout(prepareNextTrial, 2000);

        } else if (appState === 'waiting') {
            clearTimeout(timerId);
            appState = 'initial';
            message.textContent = `早すぎます！\nこの試行 (${trialCount}/${TOTAL_TRIALS}) をやり直します。\n\n画面に触れ続けてください`;
            touchArea.classList.remove('waiting');
        }
    });
    
    // 測定開始
    function startMeasurement() {
        if (appState === 'waiting') {
            appState = 'go';
            touchArea.classList.remove('waiting');
            touchArea.classList.add('go');
            message.textContent = 'スタート！';
            startTime = performance.now();
        }
    }

    // スプレッドシートにデータを保存
    function saveDataToSheet(trial, time) {
        // セッション情報と今回の試行データを結合
        const dataToSend = {
            ...sessionData, // name, age, sleepiness, etc.
            trialNumber: trial,
            reactionTime: time
        };

        fetch(webAppUrl, {
            method: 'POST', mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dataToSend),
        })
        .then(() => console.log(`Trial ${trial} data sent.`))
        .catch(error => console.error('Data sending error:', error));
    }
</script>

</body>
</html>
